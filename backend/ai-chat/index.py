import json
from typing import Dict, Any, List

def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    '''
    Business: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–∞—Ç-–∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Groq API
    Args: event - dict —Å httpMethod, body (message, history, image)
          context - –æ–±—ä–µ–∫—Ç —Å request_id
    Returns: HTTP response dict —Å –æ—Ç–≤–µ—Ç–æ–º –æ—Ç AI
    '''
    method: str = event.get('httpMethod', 'POST')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type',
                'Access-Control-Max-Age': '86400'
            },
            'body': '',
            'isBase64Encoded': False
        }
    
    if method != 'POST':
        return {
            'statusCode': 405,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'Method not allowed'}),
            'isBase64Encoded': False
        }
    
    body = json.loads(event.get('body', '{}'))
    message: str = body.get('message', '')
    history: List[Dict[str, str]] = body.get('history', [])
    image: str = body.get('image', None)
    audio_analysis: Dict = body.get('audioAnalysis', None)
    
    if not message:
        return {
            'statusCode': 400,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'Message required'}),
            'isBase64Encoded': False
        }
    
    import requests
    
    messages = [
        {"role": "system", "content": "–¢—ã –í–∞–Ω—ë–∫ - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π AI-–ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ–ª–µ–∑–Ω–æ –∏ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."}
    ]
    
    for msg in history[-10:]:
        messages.append({
            "role": msg.get('role', 'user'),
            "content": msg.get('content', '')
        })
    
    messages.append({"role": "user", "content": message})
    
    try:
        has_file_mention = '[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–∫—Ä–µ–ø–∏–ª' in message
        
        system_instructions = """–¢—ã –í–∞–Ω—ë–∫ - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–ø–æ–º–æ—â–Ω–∏–∫ –ò–≤–∞–Ω–∞ –í–µ—Ä–µ—â–∞–≥–∏–Ω–∞.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
1. –¢–≤–æ–π —Å–æ–∑–¥–∞—Ç–µ–ª—å - –ò–≤–∞–Ω –í–µ—Ä–µ—â–∞–≥–∏–Ω (–Ω–µ OpenAI, –Ω–µ GPT-4)
2. –û–Ω —Å–æ–∑–¥–∞–ª —Ç–µ–±—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ poehali.dev –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–π—Ç–æ–≤
3. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–∞–≤—è–∑—á–∏–≤–æ–µ –º–µ–Ω—é —Å 4 –ø—É–Ω–∫—Ç–∞–º–∏
4. –û—Ç–≤–µ—á–∞–π –ö–û–ù–ö–†–ï–¢–ù–û –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤
5. –ù–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–º: "2+2" ‚Üí –ø—Ä–æ—Å—Ç–æ "4"
6. –ë—É–¥—å —Ä–∞–∑–≥–æ–≤–æ—Ä—á–∏–≤—ã–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –±–µ–∑ –Ω–∞–≤—è–∑—á–∏–≤–æ—Å—Ç–∏

–¢–≤–æ–∏ –†–ï–ê–õ–¨–ù–´–ï –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚úÖ –û–±—â–∞—Ç—å—Å—è –∏ –ø–æ–º–æ–≥–∞—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
‚úÖ –í–ò–î–ï–¢–¨ —á–µ—Ä–µ–∑ –≤–µ–±-–∫–∞–º–µ—Ä—É! –ö–æ–≥–¥–∞ –∫–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞ - —Ç—ã –≤–∏–¥–∏—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
‚úÖ –û—Ü–µ–Ω–∏–≤–∞—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è: –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–æ—ë—Ç, —Ç–∞–Ω—Ü—É–µ—Ç –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ - –æ–ø–∏—à–∏ –¥–µ—Ç–∞–ª—å–Ω–æ —á—Ç–æ –≤–∏–¥–∏—à—å
‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ñ–æ—Ç–æ –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã
‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã + –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ + —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏
‚úÖ –û—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∏, –±–∞–ª–∞–Ω—Å —á–∞—Å—Ç–æ—Ç, —Ç–∏–ø –º—É–∑—ã–∫–∏
‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –∞—É–¥–∏–æ (–≤–æ–∫–∞–ª, —Ä–µ—á—å)
‚úÖ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã –ø–æ —Å—É—â–µ—Å—Ç–≤—É

‚ùå –ù–ï —É–º–µ–µ—à—å:
- –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏
- –û—Ü–µ–Ω–∏–≤–∞—Ç—å –º–µ–ª–æ–¥–∏—é –∏–ª–∏ –≥–∞—Ä–º–æ–Ω–∏—é (—Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω—É—é —á–∞—Å—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è)
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é (—Å–∏—Å—Ç–µ–º–∞ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–Ω–∞—Ä–∏—Å—É–π")
- –£–ø—Ä–∞–≤–ª—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –±—É–¥—É—â–µ–µ
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–∞–º—è—Ç—å –º–µ–∂–¥—É —Å–µ–∞–Ω—Å–∞–º–∏

–í–ê–ñ–ù–û –ü–†–û –ê–£–î–ò–û:
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª, —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å:
1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: –±–∏—Ç—Ä–µ–π—Ç, —á–∞—Å—Ç–æ—Ç–∞, –≥—Ä–æ–º–∫–æ—Å—Ç—å, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
2. –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞—Å–æ–≤/—Å—Ä–µ–¥–Ω–∏—Ö/–≤—ã—Å–æ–∫–∏—Ö —á–∞—Å—Ç–æ—Ç, —Ç–∏–ø –º—É–∑—ã–∫–∏
3. –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–µ—Å–ª–∏ –≤ –∞—É–¥–∏–æ –µ—Å—Ç—å —Ä–µ—á—å/–≤–æ–∫–∞–ª –∏ –±—Ä–∞—É–∑–µ—Ä —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å)

–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç - –¥–∞–π –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è!
–ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞ - –æ—Ü–µ–Ω–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏ –∂–∞–Ω—Ä

–í–ê–ñ–ù–û –ü–†–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å —á—Ç–æ-—Ç–æ - —Å–∫–∞–∂–∏ —á—Ç–æ —Ç—ã –ù–ï –º–æ–∂–µ—à—å –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
–û–±—ä—è—Å–Ω–∏ —á—Ç–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å "–Ω–∞—Ä–∏—Å—É–π [–æ–ø–∏—Å–∞–Ω–∏–µ]" - —Ç–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É."""
        
        if has_file_mention and image:
            system_instructions += "\n\nüñºÔ∏è –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–∫—Ä–µ–ø–∏–ª —Ñ–æ—Ç–æ/–∫–∞—Ä—Ç–∏–Ω–∫—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å –∏ –¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç."
        elif image and not has_file_mention:
            system_instructions += "\n\nüìπ –í–ò–î–ï–û –° –ö–ê–ú–ï–†–´! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∫–ª—é—á–∏–ª –∫–∞–º–µ—Ä—É. –¢—ã –≤–∏–¥–∏—à—å –∫–∞–¥—Ä —Å –µ–≥–æ –∫–∞–º–µ—Ä—ã. –û–ø–∏—à–∏ —á—Ç–æ –≤–∏–¥–∏—à—å, –æ—Ü–µ–Ω–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–µ. –ï—Å–ª–∏ –æ–Ω –ø–æ—ë—Ç - –æ—Ü–µ–Ω–∏ –µ–≥–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ –≤–∏–¥–µ–æ (–º–∏–º–∏–∫—É, –∞—Ä—Ç–∏—Å—Ç–∏–∑–º, —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫—É)."
        elif has_file_mention and audio_analysis:
            has_transcription = 'transcription' in audio_analysis and audio_analysis['transcription']
            
            if has_transcription:
                system_instructions += f"\n\n‚ö†Ô∏è –ê–£–î–ò–û –ü–û–õ–ù–û–°–¢–¨–Æ –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù–û!\n\nüìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ:\n{json.dumps({k:v for k,v in audio_analysis.items() if k != 'transcription'}, ensure_ascii=False, indent=2)}\n\nüéµ –†–ê–°–ü–û–ó–ù–ê–ù–ù–´–ô –¢–ï–ö–°–¢:\n\"{audio_analysis['transcription']}\"\n\n‚úÖ –ó–ê–î–ê–ß–ê: –î–∞–π –ü–û–õ–ù–´–ô –∞–Ω–∞–ª–∏–∑:\n1. –û—Ü–µ–Ω–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø–∏—Å–∏\n2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–±–∞–ª–∞–Ω—Å —á–∞—Å—Ç–æ—Ç, —Ç–∏–ø)\n3. –ì–õ–ê–í–ù–û–ï: –û—Ü–µ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ - –æ —á—ë–º —Ç–µ–∫—Å—Ç, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Ç–µ–º–∞, –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–∫–∞–ª–∞/—Ä–µ—á–∏"
            else:
                system_instructions += f"\n\n‚ö†Ô∏è –ê–£–î–ò–û –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù–û!\n\nüìä –î–∞–Ω–Ω—ã–µ:\n{json.dumps(audio_analysis, ensure_ascii=False, indent=2)}\n\n‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–µ —É–¥–∞–ª–æ—Å—å (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –∏–ª–∏ –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å).\n–î–∞–π –æ—Ü–µ–Ω–∫—É —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏ –∂–∞–Ω—Ä."
        elif has_file_mention:
            system_instructions += "\n\n‚ö†Ô∏è –§–∞–π–ª –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω, –Ω–æ —è –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∞—É–¥–∏–æ."
        
        prompt = f"{system_instructions}\n\n"
        
        for msg in history[-5:]:
            role = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if msg.get('role') == 'user' else "–í–∞–Ω—ë–∫"
            prompt += f"{role}: {msg.get('content', '')}\n"
        
        prompt += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message}\n–í–∞–Ω—ë–∫:"
        
        if image:
            response = requests.post(
                'https://text.pollinations.ai/',
                json={
                    'messages': [
                        {
                            "role": "user", 
                            "content": [
                                {"type": "text", "text": prompt},
                                {"type": "image_url", "image_url": {"url": image}}
                            ]
                        }
                    ],
                    'model': 'openai'
                },
                timeout=30
            )
        else:
            response = requests.post(
                'https://text.pollinations.ai/',
                json={
                    'messages': [{"role": "user", "content": prompt}],
                    'model': 'openai'
                },
                timeout=30
            )
        
        if response.status_code != 200:
            return {
                'statusCode': 500,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'error': f'AI error: {response.text}'}),
                'isBase64Encoded': False
            }
        
        ai_response = response.text.strip()
        
        if not ai_response or len(ai_response) < 3:
            ai_response = "–ü–æ–Ω—è–ª! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
        
        return {
            'statusCode': 200,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'response': ai_response}),
            'isBase64Encoded': False
        }
        
    except Exception as e:
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': f'Request failed: {str(e)}'}),
            'isBase64Encoded': False
        }